<jnt-informer *ngIf="errors.length > 0"
              (ok)="errors = []">
  <jnt-informer-message *ngFor="let error of errors"
                        [message]="error.toString()"></jnt-informer-message>
</jnt-informer>

<jnt-app-page-header [icon]="localUi.icons.milestone"
                     [title]="milestone.title"
                     [teaser]="milestone.owner?.fullTitle"></jnt-app-page-header>

<jnt-block [padding]="ui.gutter.none">
  <jnt-form [formGroup]="form">
    <jnt-gantt cdkDropListGroup data-tickets i18n-title="@@label.tickets"
               title="Tickets"
               [loading]="progress.tickets">
      <ng-template #toolsTemplate>
        <jnt-stack [orientation]="ui.orientation.horizontal"
                   [gutter]="ui.gutter.small"
                   [align]="ui.align.center">
          <jnt-button [outline]="ui.outline.transparent"
                      [icon]="ui.icons.add"
                      [size]="ui.size.small"
                      (click)="add()">
          </jnt-button>
          <jnt-button [outline]="ui.outline.transparent"
                      [icon]="progress.tickets ? ui.icons.animated.reload : ui.icons.reload"
                      [size]="ui.size.small"
                      [disabled]="progress.tickets"
                      (click)="loadTickets()">
          </jnt-button>
          <jnt-switcher formControlName="type"
                        [width]="ui.width.fluid">
            <jnt-switcher-option label="All"
                                 i18n-label="@@action.filter_issues_all"
                                 [value]="ticketsTypes.all">
              <jnt-badge *ngIf="summary?.count"
                         [value]="summary?.count"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Created"
                                 i18n-label="@@label.created"
                                 [value]="ticketsTypes.created">
              <jnt-badge *ngIf="summary?.createdCount"
                         [value]="summary?.createdCount"
                         [color]="ui.color.purple"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Planning"
                                 i18n-label="@@label.planning"
                                 [disabled]="summary?.planningCount <= 0"
                                 [value]="ticketsTypes.planning">
              <jnt-badge *ngIf="summary?.planningCount > 0"
                         [value]="summary?.planningCount"
                         [color]="ui.color.red"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Doing"
                                 i18n-label="@@label.doing"
                                 [value]="ticketsTypes.doing">
              <jnt-badge *ngIf="summary?.doingCount"
                         [value]="summary?.doingCount"
                         [color]="ui.color.blue"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Testing"
                                 i18n-label="@@label.testing"
                                 [value]="ticketsTypes.testing">
              <jnt-badge *ngIf="summary?.testingCount"
                         [value]="summary?.testingCount"
                         [color]="ui.color.yellow"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Accepting"
                                 i18n-label="@@label.accepting"
                                 [value]="ticketsTypes.accepting">
              <jnt-badge *ngIf="summary?.acceptingCount"
                         [value]="summary?.acceptingCount"
                         [color]="ui.color.gray"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Done"
                                 i18n-label="@@label.done"
                                 [value]="ticketsTypes.done">
              <jnt-badge *ngIf="summary?.doneCount"
                         [value]="summary?.doneCount"
                         [color]="ui.color.green"></jnt-badge>
            </jnt-switcher-option>
          </jnt-switcher>
        </jnt-stack>
      </ng-template>

      <ng-container *ngFor="let ticket of tickets">
        <jnt-gantt-line>
          <jnt-gantt-line-period [from]="ticket.startDate"
                                 [to]="ticket.dueDate">
            <ng-template #indicatorMonth let-current="current">
              <div period [attr.over-from]="(ticket['startDate'] | dfnsGetMonth) < (current | dfnsGetMonth)"
                   [attr.over-to]="(ticket['dueDate'] | dfnsGetMonth) > (current | dfnsGetMonth)"
                   [attr.over-due]="ticket.problems | includes:ticketProblem.overDueDate">
                <div label>
                  {{(ticket.metrics.issuesOpenedCount ? ticket.metrics.openedTimeRemains : ticket.metrics.timeRemains) |
                  duration:durationFormat.short}}
                </div>
                <div progress [style.transform]="'translateX(-' + (100 - (ticket.metrics.timeEstimate > 0
                  ? ticket.metrics.timeSpent / ticket.metrics.timeEstimate * 100 : 0)) + '%)'">
                </div>
              </div>
            </ng-template>
            <ng-template #title>
              <jnt-stack cdkDropList [id]="ticket.id"
                         [orientation]="ui.orientation.horizontal"
                         [justify]="ui.justify.between"
                         [align]="ui.align.center"
                         [attr.ticket]="ticket.id"
                         [attr.current]="ticket.id === ticketControl.value"
                         [cdkDropListEnterPredicate]="predicate"
                         (cdkDropListDropped)="drop($event, ticket.id)">
                <jnt-stack [orientation]="ui.orientation.horizontal"
                           [align]="ui.align.center"
                           [gutter]="ui.gutter.small">
                  <jnt-button [outline]="ui.outline.transparent"
                              [size]="ui.size.small"
                              [icon]="ticketControl.value === ticket.id ? ui.icons.chevronDown : ui.icons.chevronRight"
                              (click)="toggleIssues(ticket.id)">
                  </jnt-button>
                  <jnt-dot [color]="ticket.type === ticketTypes.feature ? ui.color.green
                    : (ticket.type === ticketTypes.improvement ? ui.color.purple : ui.color.red)">
                  </jnt-dot>
                  <jnt-link [title]="ticket.title"
                            (click)="toggleIssues(ticket.id)"></jnt-link>
                  <jnt-label *ngIf="ticket.role as role"
                             [color]="ui.color.paleNavy"
                             [label]="role">
                  </jnt-label>
                </jnt-stack>

                <jnt-stack [orientation]="ui.orientation.horizontal"
                           [align]="ui.align.center"
                           [gutter]="ui.gutter.small">
                  <jnt-link *ngIf="ticket.url"
                            [icon]="ui.icons.link"
                            [source]="ticket.url"
                            [target]="ui.target.blank">
                  </jnt-link>
                  <jnt-label *ngIf="ticket.metrics.issuesClosedCount as issuesClosedCount"
                             [color]="ui.color.green"
                             [label]="issuesClosedCount.toString()">
                  </jnt-label>
                  <jnt-label *ngIf="ticket.metrics.issuesOpenedCount as issuesOpenedCount"
                             [color]="ui.color.paleNavy"
                             [label]="issuesOpenedCount.toString()">
                  </jnt-label>
                  <ng-container [ngSwitch]="ticket.state">
                    <jnt-label *ngSwitchCase="ticketStates.created"
                               [color]="ticketStates.created | ticketStateColor"
                               label="Created"
                               i18n-label="@@label.created">
                    </jnt-label>
                    <jnt-label *ngSwitchCase="ticketStates.planning"
                               [color]="ticketStates.planning | ticketStateColor"
                               label="Planning"
                               i18n-label="@@label.planning">
                    </jnt-label>
                    <jnt-label *ngSwitchCase="ticketStates.doing"
                               [color]="ticketStates.doing | ticketStateColor"
                               label="Doing"
                               i18n-label="@@label.doing">
                    </jnt-label>
                    <jnt-label *ngSwitchCase="ticketStates.testing"
                               [color]="ticketStates.testing | ticketStateColor"
                               label="Testing"
                               i18n-label="@@label.testing">
                    </jnt-label>
                    <jnt-label *ngSwitchCase="ticketStates.accepting"
                               [color]="ticketStates.accepting | ticketStateColor"
                               label="Accepting"
                               i18n-label="@@label.accepting">
                    </jnt-label>
                    <jnt-label *ngSwitchCase="ticketStates.done"
                               [color]="ticketStates.done | ticketStateColor"
                               label="Done"
                               i18n-label="@@label.done">
                    </jnt-label>
                  </ng-container>
                  <jnt-button [outline]="ui.outline.transparent"
                              [icon]="ui.icons.actions"
                              [loading]="progress.deleting[ticket.id]"
                              (attached)="instance.popover = $event"
                              [jntPopover]="{
                              contentTemplate: dropdownTemplate,
                              trigger: ui.trigger.click
                            }">
                  </jnt-button>
                  <ng-template #dropdownTemplate>
                    <jnt-menu [orientation]="ui.orientation.vertical"
                              [spacing]="ui.gutter.small">
                      <jnt-menu-item title="Edit"
                                     i18n-title="@@action.edit"
                                     [icon]="ui.icons.edit"
                                     (click)="edit(ticket)"></jnt-menu-item>
                      <jnt-menu-item title="Delete"
                                     i18n-title="@@action.delete"
                                     [icon]="ui.icons.delete"
                                     (click)="delete(ticket.id)"></jnt-menu-item>
                    </jnt-menu>
                  </ng-template>
                </jnt-stack>
              </jnt-stack>
            </ng-template>
          </jnt-gantt-line-period>
        </jnt-gantt-line>

        <ng-template #noIssuesTemplate>
          <ng-template #loadingIssuesTemplate>
            <jnt-gantt-line>
              <jnt-gantt-line-period>
                <ng-template #title>
                  <jnt-skeleton [type]="ui.skeleton.type.text"
                                [lines]="ticket.metrics.issuesCount || 1"></jnt-skeleton>
                </ng-template>
              </jnt-gantt-line-period>
            </jnt-gantt-line>
          </ng-template>
          <ng-container *ngIf="!progress.issues; else loadingIssuesTemplate">
            <jnt-gantt-line>
              <jnt-gantt-line-period>
                <ng-template #title>
                  <p>No one issue has been attached to ticket.</p>
                </ng-template>
              </jnt-gantt-line-period>
            </jnt-gantt-line>
          </ng-container>
        </ng-template>
        <ng-container *ngIf="ticketControl.value === ticket.id">
          <ng-container *ngIf="issues.length > 0; else noIssuesTemplate">

            <div *ngFor="let i of issues">{{i.title}}</div>

            <jnt-gantt-line cdkDropList *ngFor="let issue of issues"
                            [cdkDropListEnterPredicate]="predicateIssue">
              <jnt-gantt-line-period [from]="[ticket.startDate, issue.dueDate] | dfnsMin"
                                     [to]="issue.dueDate">
                <ng-template #indicatorMonth let-period="period"
                             let-current="current">
                  <div [attr.over-from]="(period['startDate'] | dfnsGetMonth) < (current | dfnsGetMonth)"
                       [attr.over-to]="(period['dueDate'] | dfnsGetMonth) > (current | dfnsGetMonth)" period>
                    <ng-container *ngIf="issue.timeEstimate">
                      <div label>{{issue.metrics.remains | duration:durationFormat.short}}</div>
                      <div progress [style.transform]="'translateX(-' + 100 - (issue.state === issueStates.opened && issue.timeEstimate > 0
                        ? issue.totalTimeSpent / issue.timeEstimate * 100 : 0) + '%)'">
                      </div>
                    </ng-container>
                  </div>
                </ng-template>
                <ng-template #title>
                  <jnt-stack issue cdkDrag [orientation]="ui.orientation.horizontal"
                             [gutter]="ui.gutter.small"
                             [cdkDragData]="{issue: issue.id}">
                    <jnt-button cdkDragHandle [icon]="ui.icons.menu"
                                [scheme]="ui.scheme.secondary"
                                [size]="ui.size.tiny"></jnt-button>
                    <app-issue [issue]="issue"></app-issue>
                  </jnt-stack>
                </ng-template>
              </jnt-gantt-line-period>
            </jnt-gantt-line>
          </ng-container>
        </ng-container>
      </ng-container>
    </jnt-gantt>
  </jnt-form>
</jnt-block>

