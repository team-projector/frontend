<jnt-informer *ngIf="errors.length > 0"
              (ok)="errors = []">
  <jnt-informer-message *ngFor="let error of errors"
                        [message]="error.toString()"></jnt-informer-message>
</jnt-informer>

<jnt-form [formGroup]="form">
  <jnt-table #table [features]="[ui.feature.reload, ui.feature.search]"
             formControlName="table">
    <ng-template #tableFiltersTemplate>
      <jnt-stack [orientation]="ui.orientation.horizontal">
        <jnt-switcher formControlName="type">
          <jnt-switcher-option i18n-label="@@action.filter_issues_all"
                               label="All"
                               [value]="milestoneType.all">
            <jnt-badge *ngIf="summary?.count"
                       [color]="ui.color.green"
                       [overflow]="999"
                       [value]="summary?.count"></jnt-badge>
          </jnt-switcher-option>
          <jnt-switcher-option i18n-label="@@action.filter_type_closed"
                               label="Closed"
                               [value]="milestoneType.closed">
            <jnt-badge *ngIf="summary?.closedCount"
                       [color]="ui.color.yellow"
                       [overflow]="999"
                       [value]="summary?.closedCount"></jnt-badge>
          </jnt-switcher-option>
          <jnt-switcher-option i18n-label="@@action.filter_type_active"
                               label="Active"
                               [value]="milestoneType.active">
            <jnt-badge *ngIf="summary?.activeCount"
                       [color]="ui.color.green"
                       [value]="summary?.activeCount"></jnt-badge>
          </jnt-switcher-option>
        </jnt-switcher>
      </jnt-stack>
    </ng-template>
    <jnt-table-column i18n-title="@@label.title" title="Title">
      <ng-template #tableCellTemplate
                   let-title="title"
                   let-id="id"
                   let-owner="owner"
                   let-state="state">
        <jnt-stack [orientation]="ui.orientation.horizontal">
          <jnt-avatar [size]="ui.size.small"
                      [image]="owner.glAvatar"></jnt-avatar>
          <jnt-stack [gutter]="ui.gutter.tiny">
            <jnt-link [source]="[id]" [target]="ui.target.blank"
                      [title]="title"
                      [attr.data-closed]="state == milestoneState.closed">
            </jnt-link>
            <small>{{owner?.fullTitle}}</small>
          </jnt-stack>
        </jnt-stack>
      </ng-template>
    </jnt-table-column>
    <jnt-table-column width="15%"
                      title="Period"
                      i18n-title="@@label.period"
                      [align]="ui.text.align.center">
      <ng-template #tableCellTemplate let-startDate="startDate" let-problems="problems" let-dueDate="dueDate">
        <jnt-stack [gutter]="ui.gutter.tiny" [align]="ui.align.stretch">
          <jnt-date-period [start]="startDate" [end]="dueDate"></jnt-date-period>
          <jnt-label *ngIf="problems?.includes(milestoneProblem.overDueDate)"
                     [color]="ui.color.red" label="overdue">
          </jnt-label>
        </jnt-stack>
      </ng-template>
    </jnt-table-column>

    <jnt-table-column width="15%"
                      title="Budget"
                      i18n-title="@@label.budget"
                      [align]="ui.text.align.center">
      <ng-template #tableCellTemplate let-budget="budget" let-metrics="metrics">
        <ng-container *ngIf="budget">
          <app-budget [spent]="metrics.budgetSpent"
                      [budget]="budget"
                      [remains]="metrics.budgetRemains"></app-budget>
        </ng-container>
      </ng-template>
    </jnt-table-column>

    <jnt-table-column width="15%"
                      title="Profit"
                      i18n-title="@@label.profit"
                      [align]="ui.text.align.center">
      <ng-template #tableCellTemplate let-budget="budget" let-metrics="metrics">
        <app-profit [payroll]="metrics.payroll"
                    [budget]="budget"
                    [profit]="metrics.profit"></app-profit>
      </ng-template>
    </jnt-table-column>

    <jnt-table-column width="15%"
                      title="Progress"
                      i18n-title="@@label.progress"
                      [align]="ui.text.align.center">
      <ng-template #tableCellTemplate let-metrics="metrics">
        <app-work-progress [estimate]="metrics.timeEstimate"
                           [spent]="metrics.timeSpent"></app-work-progress>
      </ng-template>
    </jnt-table-column>
    <jnt-table-column width="150px"
                      title="Issues"
                      i18n-title="@@label.issues"
                      [align]="ui.text.align.center">
      <ng-template #tableCellTemplate let-metrics="metrics">
        <jnt-stack [justify]="ui.justify.center"
                   [orientation]="ui.orientation.horizontal"
                   [gutter]="ui.gutter.tiny">
          <jnt-label *ngIf="metrics.issuesOpenedCount" [label]="metrics.issuesOpenedCount"
                     [color]="ui.color.green"></jnt-label>
          <jnt-label *ngIf="metrics.issuesClosedCount" [label]="metrics.issuesClosedCount"
                     [color]="ui.color.paleNavy"></jnt-label>
        </jnt-stack>
      </ng-template>
    </jnt-table-column>

    <ng-template #tableRowActionsTemplate let-row="row" let-hide="hide">
      <jnt-menu [orientation]="ui.orientation.vertical"
                [spacing]="ui.gutter.small">
        <jnt-menu-item [icon]="ui.icons.link"
                       title="GitLab"
                       i18n-title="@@action.view_on_gitlab"
                       target="_blank"
                       [link]="row.glUrl"></jnt-menu-item>
        <jnt-menu-item [icon]="ui.icons.edit"
                       title="Edit"
                       i18n-title="@@action.edit"
                       target="_blank"
                       [link]="'/admin/development/milestone/' + row.id + '/change/'"></jnt-menu-item>
        <jnt-menu-item [icon]="ui.icons.sync"
                       title="Sync"
                       i18n-title="@@action.sync_from_gitlab"
                       [loading]="progress.syncing"
                       (click)="sync(row.id, hide)"></jnt-menu-item>
      </jnt-menu>
    </ng-template>

  </jnt-table>
</jnt-form>

