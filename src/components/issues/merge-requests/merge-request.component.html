<jnt-block [padding]="ui.gutter.none" [width]="ui.width.fluid">
  <jnt-form [formGroup]="form">
    <jnt-table #table [features]="[ui.collections.table.features.search]" (reloaded)="loadSummary(); reloaded.emit()"
               formControlName="table">
      <ng-template #filters>
        <jnt-stack [type]="ui.layout.stack.type.horizontal">
          <jnt-switcher formControlName="state">
            <jnt-switcher-option label="Closed"
                                 i18n-label="@@action.filter_type_closed"
                                 [value]="mergeRequestState.closed">
              <jnt-badge *ngIf="summary?.closedCount"
                         [value]="summary?.closedCount.toString()"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Opened"
                                 i18n-label="@@action.filter_type_opened"
                                 [value]="mergeRequestState.opened">
              <jnt-badge *ngIf="summary?.openedCount"
                         [value]="summary?.openedCount.toString()"
                         [color]="ui.color.green"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Merged"
                                 i18n-label="@@action.filter_type_merged"
                                 [value]="mergeRequestState.merged">
              <jnt-badge *ngIf="summary?.mergedCount"
                         [value]="summary?.mergedCount.toString()"
                         [color]="ui.color.red"></jnt-badge>
            </jnt-switcher-option>
          </jnt-switcher>
        </jnt-stack>
      </ng-template>
      <jnt-table-column sort="title"
                        title="Title"
                        i18n-title="@@label.title">
        <ng-template #cellTemplate let-title="title" let-labels="labels" let-url="glUrl" let-state="state"
                     let-issues="issues" let-user="user" let-project="project">
          <jnt-stack [type]="ui.layout.stack.type.horizontal"
                     [gutter]="ui.gutter.small">
            <jnt-stack [type]="ui.layout.stack.type.horizontal"
                       [gutter]="ui.gutter.small"
                       [align]="ui.flex.align.center">
              <jnt-avatar [text]="issues[0]?.user.name"
                          [image]="issues[0]?.user.avatar"
                          [size]="ui.size.tiny"></jnt-avatar>
              <jnt-icon [icon]="ui.icons.chevronRight"></jnt-icon>
              <jnt-avatar [text]="user?.name"
                          [image]="user?.avatar"
                          [size]="ui.size.tiny"></jnt-avatar>
            </jnt-stack>

            <jnt-stack [type]="ui.layout.stack.type.vertical"
                       [gutter]="ui.gutter.tiny">
              <jnt-stack [type]="ui.layout.stack.type.horizontal"
                         [gutter]="ui.gutter.small">
                <jnt-link [source]="url" target="_blank"
                          [attr.closed]="state == mergeRequestState.closed" [title]="title">
                </jnt-link>
                <jnt-label *ngFor="let l of labels" [color]="l.color" [label]="l.title"></jnt-label>

              </jnt-stack>
              <small>{{project?.fullTitle}}</small>
            </jnt-stack>
          </jnt-stack>
        </ng-template>
      </jnt-table-column>

      <jnt-table-column title="Progress"
                        i18n-title="@@label.progress">
        <ng-template #cellTemplate let-timeEstimate="timeEstimate"
                     let-totalTimeSpent="totalTimeSpent"
                     let-metrics="metrics"
                     let-problems="problems">
          <jnt-progress-bar progress *ngIf="!!timeEstimate" [value]="totalTimeSpent / timeEstimate * 100">
            <ng-template #progressBarLegendTemplate>
              <jnt-stack [type]="ui.layout.stack.type.horizontal" [align]="ui.flex.align.center"
                         [justify]="ui.flex.justify.between" [gutter]="ui.gutter.normal">
                <div metric>{{totalTimeSpent | duration}}</div>
                <div metric estimate>{{timeEstimate | duration}}</div>
              </jnt-stack>
            </ng-template>
          </jnt-progress-bar>
          <div style="text-align: center;">
            <span [attr.slow]="metrics.efficiency > 0 && metrics.efficiency < 0.8">
              {{!!metrics.efficiency ? (metrics.efficiency | number:'1.2-2') : ''}}
            </span>
          </div>
          <jnt-label *ngIf="problems?.includes(issueProblem.emptyEstimate)"
                     [color]="ui.color.red"
                     label="estimate"
                     i18n-label="@@label.estimate">
          </jnt-label>
        </ng-template>
      </jnt-table-column>

      <jnt-table-column *ngIf="view === viewType.extended"
                        title="Payroll"
                        i18n-title="@@label.payroll">
        <ng-template #cellTemplate let-metrics="metrics">
          <div style="text-align: right;">
            {{!!metrics.payroll ? (metrics.payroll | currency) : '&mdash;'}}
            /
            {{!!metrics.paid ? (metrics.paid | currency) : '&mdash;'}}
          </div>
        </ng-template>
      </jnt-table-column>
    </jnt-table>
  </jnt-form>
</jnt-block>
