<jnt-block [width]="ui.width.fluid">
  <jnt-form [formGroup]="form">
    <jnt-table #table [features]="[features.search]" (reloaded)="loadSummary(); reloaded.emit()"
               formControlName="table">
      <ng-template #filters>
        <jnt-stack [type]="ui.stack.type.horizontal">
          <jnt-switcher formControlName="type">
            <jnt-switcher-option label="All" [value]="issuesType.all">
              <jnt-badge *ngIf="summary?.count"
                         [count]="summary?.count.toString()"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Closed" [value]="issuesType.closed">
              <jnt-badge *ngIf="summary?.closedCount"
                         [count]="summary?.closedCount.toString()"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Opened" [value]="issuesType.opened">
              <jnt-badge *ngIf="summary?.openedCount"
                         [count]="summary?.openedCount.toString()"
                         [color]="ui.colors.green"></jnt-badge>
            </jnt-switcher-option>
            <jnt-switcher-option label="Problems" [value]="issuesType.problems">
              <jnt-badge *ngIf="summary?.problemsCount"
                         [count]="summary?.problemsCount.toString()"
                         [color]="ui.colors.red"></jnt-badge>
            </jnt-switcher-option>
          </jnt-switcher>
        </jnt-stack>
      </ng-template>
      <jnt-table-column i18n-title="@@issue_title" title="Title">
        <ng-template #cellTemplate let-title="title" let-labels="labels" let-glUrl="glUrl" let-state="state"
                     let-user="user" let-project="project" let-ticket="ticket"
                     let-closedAt="closedAt" let-id="id">
          <app-issue [issue]="{id: id, title: title, labels: labels, glUrl: glUrl, state: state,
            user: user, project: project, ticket: ticket, closedAt: closedAt}">
          </app-issue>
        </ng-template>
      </jnt-table-column>

      <jnt-table-column i18n-title="@@dueDate" title="Due date">
        <ng-template #cellTemplate let-dueDate="dueDate" let-problems="problems">
          <jnt-stack [gutter]="ui.gutter.tiny">
            <app-due-date *ngIf="dueDate" [dueDate]="dueDate"></app-due-date>
            <jnt-stack [type]="ui.stack.type.vertical">
              <jnt-label *ngIf="problems?.includes(issueProblem.emptyDueDate)"
                         [size]="ui.sizes.small"
                         [color]="ui.colors.red" label="empty">
              </jnt-label>
              <jnt-label *ngIf="problems?.includes(issueProblem.overDueDate)"
                         [size]="ui.sizes.small"
                         [color]="ui.colors.red" label="overdue">
              </jnt-label>
            </jnt-stack>
          </jnt-stack>
        </ng-template>
      </jnt-table-column>

      <jnt-table-column i18n-title="@@progress" title="Progress">
        <ng-template #cellTemplate let-timeEstimate="timeEstimate"
                     let-timeSpent="timeSpent"
                     let-totalTimeSpent="totalTimeSpent"
                     let-metrics="metrics"
                     let-problems="problems">
          <jnt-progress-bar progress *ngIf="!!timeEstimate"
                            [value]="totalTimeSpent / timeEstimate * 100">
            <ng-template #legend>
              <jnt-stack [type]="ui.stack.type.horizontal" [align]="ui.flex.align.center"
                         [justify]="ui.flex.justify.between" [gutter]="ui.gutter.normal">
                <div metric>
                  {{totalTimeSpent | duration}}
                  <span collaboration *ngIf="totalTimeSpent !== timeSpent">
                    +{{totalTimeSpent - timeSpent | duration}}
                  </span>
                </div>
                <div metric estimate>{{timeEstimate | duration}}</div>
              </jnt-stack>
            </ng-template>
          </jnt-progress-bar>
          <div efficiency>
            <span [attr.slow]="metrics.efficiency > 0 && metrics.efficiency < 0.8">
              {{!!metrics.efficiency ? (metrics.efficiency | number:'1.2-2') : ''}}
            </span>
          </div>
          <jnt-label *ngIf="problems?.includes(issueProblem.emptyEstimate)"
                     [size]="ui.sizes.small"
                     [color]="ui.colors.red" label="estimate">
          </jnt-label>
        </ng-template>
      </jnt-table-column>

      <jnt-table-column *ngIf="view === viewType.extended" i18n-title="@@payroll" title="Payroll">
        <ng-template #cellTemplate let-metrics="metrics">
          <div style="text-align: right;">
            {{!!metrics.payroll ? (metrics.payroll | currency) : '&mdash;'}}
            /
            {{!!metrics.paid ? (metrics.paid | currency) : '&mdash;'}}
          </div>
        </ng-template>
      </jnt-table-column>

      <ng-template #rowActions let-row="row">
        <jnt-menu [type]="ui.orientation.vertical" [spacer]="ui.sizes.small">
          <jnt-menu-item [icon]="ui.icons.sync" title="Sync from GitLab"
                         (click)="sync(row.id)"></jnt-menu-item>
        </jnt-menu>
      </ng-template>
    </jnt-table>
  </jnt-form>
</jnt-block>
