<jnt-stack [gutter]="ui.stack.gutter.large">
  <form [formGroup]="form">
    <jnt-stack>
      <jnt-stack presentations [type]="ui.stack.type.horizontal">
        <jnt-switcher formControlName="metric">
          <jnt-switcher-option label="Spent" [value]="metricType.spent">
            <jnt-dot [color]="ui.colors.green"></jnt-dot>
          </jnt-switcher-option>
          <jnt-switcher-option label="Estimated" [value]="metricType.estimate">
            <jnt-dot [color]="ui.colors.red"></jnt-dot>
          </jnt-switcher-option>
          <jnt-switcher-option label="Remains" [value]="metricType.remains">
            <jnt-dot [color]="ui.colors.yellow"></jnt-dot>
          </jnt-switcher-option>
          <jnt-switcher-option label="Loading" [value]="metricType.loading">
            <jnt-dot [color]="ui.colors.purpleDark"></jnt-dot>
          </jnt-switcher-option>
        </jnt-switcher>
      </jnt-stack>

      <jnt-block>
        <jnt-calendar formControlName="dueDate" (updated)="period = $event">
          <jnt-week-metric i18n-title="@@est" title="Est"></jnt-week-metric>
          <jnt-week-metric i18n-title="@@spent" title="Spent"></jnt-week-metric>
          <jnt-week-metric i18n-title="@@eff" title="Eff"></jnt-week-metric>
          <jnt-week-metric i18n-title="@@payroll" title="Payroll"></jnt-week-metric>
          <jnt-week-metric i18n-title="@@paid" title="Paid"></jnt-week-metric>
          <ng-template #dayTemplate let-date="date">
            <div class="day" [attr.today]="isToday(date)">
              <ng-container *ngTemplateOutlet="dayMetricTemplate; context: {presentation: metric.value,
                date: date, metric: metrics.days.get(format(date, formatDate))}">
              </ng-container>
            </div>
          </ng-template>
          <ng-template #metricTemplate let-metric="metric" let-date="date">
            <ng-container *ngIf="metrics.weeks.get(format(date, formatDate)) as weekMetric">
              <ng-container [ngSwitch]="metric">
                <ng-container *ngSwitchCase="0">
                  {{!!weekMetric.timeEstimate ? (weekMetric.timeEstimate | duration:durationFormat.short) : '&ndash;'}}
                </ng-container>
                <ng-container *ngSwitchCase="1">
                  {{!!weekMetric.timeSpent ? (weekMetric.timeSpent | duration:durationFormat.short) : '&ndash;'}}
                </ng-container>
                <ng-container *ngSwitchCase="2">
                  {{!!weekMetric.efficiency ? (weekMetric.efficiency | number:'1.2-2') : '&ndash;'}}
                </ng-container>
                <ng-container *ngSwitchCase="3">
                  {{!!weekMetric.payroll ? (weekMetric.payroll | currency:'RUB') : '&ndash;'}}
                </ng-container>
                <ng-container *ngSwitchCase="4">
                  {{!!weekMetric.paid ? (weekMetric.paid | currency:'RUB') : '&ndash;'}}
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-template>
        </jnt-calendar>
      </jnt-block>
    </jnt-stack>
  </form>

  <div filter *ngIf="dueDate.value">
    {{dueDate.value | date}}
    <jnt-icon icon [icon]="ui.icons.close" (click)="dueDate.patchValue(null)"></jnt-icon>
  </div>

  <jnt-menu>
    <jnt-menu-item link="./" title="Issues">
      <jnt-badge *ngIf="summary?.issuesCount" [count]="summary?.issuesCount"></jnt-badge>
      <jnt-badge *ngIf="summary?.problemsCount" [count]="summary?.problemsCount" [scheme]="ui.schemes.fail"></jnt-badge>
    </jnt-menu-item>
    <jnt-menu-item link="time-expenses" title="Time Expenses">
      <jnt-badge *ngIf="summary?.timeSpent" [count]="summary?.timeSpent | duration"></jnt-badge>
    </jnt-menu-item>
  </jnt-menu>
  <router-outlet></router-outlet>
</jnt-stack>

<ng-template #dayMetricTemplate let-metric="metric" let-date="date" let-presentation="presentation">
  <div issues *ngIf="!!metric?.issuesCount"></div>
  <div *ngIf="!!metric" metric [ngSwitch]="presentation">

    <ng-template #no_metric>{{date | getDate}}</ng-template>

    <ng-template #metrics let-metric="metric" let-color="color" let-planned="planned" let-show="show">
      <jnt-circle-bar *ngIf="show && !!metric; else no_metric" circle time>
        <ng-template #content>{{metric | duration:durationFormat.short}}</ng-template>
        <jnt-bar-indicator-group>
          <jnt-bar-indicator [color]="color"
                             [value]="metric | percentage:(planned * 3600)">
          </jnt-bar-indicator>
        </jnt-bar-indicator-group>
      </jnt-circle-bar>
    </ng-template>

    <ng-container *ngSwitchCase="metricType.spent">
      <ng-container *ngTemplateOutlet="metrics; context: {metric: metric.timeSpent, color: ui.colors.green,
        planned: metric.plannedWorkHours, show: !isFuture(date)}">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchCase="metricType.estimate">
      <ng-container *ngTemplateOutlet="metrics; context: {metric: metric.timeEstimate, color: ui.colors.red,
        planned: metric.plannedWorkHours, show: isFuture(date)}">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchCase="metricType.remains">
      <ng-container *ngTemplateOutlet="metrics; context: {metric: metric.timeRemains, color: ui.colors.yellow,
        planned: metric.plannedWorkHours, show: isFuture(date)}">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchCase="metricType.loading">
      <ng-container *ngTemplateOutlet="metrics; context: {metric: metric.loading, color: ui.colors.purpleDark,
        planned: metric.plannedWorkHours, show: isFuture(date)}">
      </ng-container>
    </ng-container>

    <ng-container *ngSwitchDefault>
      <ng-container>
        <jnt-circle-bar circle>
          <ng-template #content>{{date | getDate}}</ng-template>
          <jnt-bar-indicator-group>
            <jnt-bar-indicator [color]="ui.colors.green"
                               [value]="metric.timeSpent | percentage:(metric.plannedWorkHours * 3600)">
            </jnt-bar-indicator>
            <jnt-bar-indicator *ngIf="isFuture(date)" [color]="ui.colors.yellow"
                               [value]="metric.timeRemains | percentage:(metric.plannedWorkHours * 3600)">
            </jnt-bar-indicator>
          </jnt-bar-indicator-group>
          <jnt-bar-indicator-group *ngIf="isFuture(date)">
            <jnt-bar-indicator [color]="ui.colors.red"
                               [value]="metric.timeEstimate | percentage:(metric.plannedWorkHours * 3600)">
            </jnt-bar-indicator>
          </jnt-bar-indicator-group>
          <jnt-bar-indicator-group *ngIf="isFuture(date)">
            <jnt-bar-indicator [color]="ui.colors.purpleDark"
                               [value]="metric.loading | percentage:(metric.plannedWorkHours * 3600)">
            </jnt-bar-indicator>
          </jnt-bar-indicator-group>
        </jnt-circle-bar>
      </ng-container>
    </ng-container>
  </div>
</ng-template>
