<jnt-container [fluid]="true">
  <jnt-stack [gutter]="ui.stack.gutter.large">
    <form [formGroup]="filterForm">
      <jnt-stack>
        <jnt-block>
          <jnt-calendar formControlName="dueDate" (updated)="period = $event">
            <jnt-week-metric i18n-title="@@est" title="Est"></jnt-week-metric>
            <jnt-week-metric i18n-title="@@spent" title="Spent"></jnt-week-metric>
            <jnt-week-metric i18n-title="@@eff" title="Eff"></jnt-week-metric>
            <jnt-week-metric i18n-title="@@payroll" title="Payroll"></jnt-week-metric>
            <jnt-week-metric i18n-title="@@paid" title="Paid"></jnt-week-metric>
            <ng-template #dayTemplate let-date="date">
              <div class="day">
                <ng-container
                  *ngTemplateOutlet="dayMetricTemplate; context: {date: date, metric: metrics.days.get(format(date, formatDate))}"></ng-container>
              </div>
            </ng-template>
            <ng-template #metricTemplate let-metric="metric" let-date="date">
              <ng-container *ngIf="metrics.weeks.get(format(date, formatDate)) as weekMetric">
                <ng-container [ngSwitch]="metric">
                  <ng-container *ngSwitchCase="0">{{weekMetric.timeEstimate | duration:durationFormat.short}}
                  </ng-container>
                  <ng-container *ngSwitchCase="1">{{weekMetric.timeSpent | duration:durationFormat.short}}
                  </ng-container>
                  <ng-container *ngSwitchCase="2">{{weekMetric.efficiency | number:'1.2-2'}}x</ng-container>
                  <ng-container *ngSwitchCase="3">{{weekMetric.payroll | currency:'RUB':'symbol':'4.0-0'}}
                  </ng-container>
                  <ng-container *ngSwitchCase="4">{{weekMetric.paid | currency:'RUB':'symbol':'4.0-0'}}</ng-container>
                </ng-container>
              </ng-container>
            </ng-template>
          </jnt-calendar>
        </jnt-block>
      </jnt-stack>
    </form>

    <div filter *ngIf="dueDate.value">
      {{dueDate.value | date}}
      <jnt-icon icon [icon]="ui.icons.close"
                (click)="dueDate.patchValue(null)"></jnt-icon>
    </div>

    <jnt-menu>
      <jnt-menu-item link="issues" title="Issues"></jnt-menu-item>
      <jnt-menu-item link="problems" title="Problems"></jnt-menu-item>
      <jnt-menu-item link="time-expenses" title="Time Expenses"></jnt-menu-item>
    </jnt-menu>
    <router-outlet></router-outlet>
  </jnt-stack>
</jnt-container>

<ng-template #dayMetricTemplate let-metric="metric" let-date="date">
  <jnt-circle-bar class="metric"
                  [title]="'Spent: ' + (metric?.timeSpent | duration) + ', estimate: ' + (metric?.timeEstimate | duration) + ', loading: ' + (metric?.loading | duration)">
    <ng-template #content>{{date | getDate}}</ng-template>
    <jnt-bar-indicator-group>
      <jnt-bar-indicator *ngIf="metric?.timeSpent" [color]="ui.colors.green"
                         [value]="metric.timeSpent | percentage:(metric.plannedWorkHours * 3600)">
      </jnt-bar-indicator>
      <jnt-bar-indicator *ngIf="metric?.timeRemains" [color]="ui.colors.yellow"
                         [value]="metric.timeRemains | percentage:(metric.plannedWorkHours * 3600)">
      </jnt-bar-indicator>
    </jnt-bar-indicator-group>
    <jnt-bar-indicator-group>
      <jnt-bar-indicator *ngIf="metric?.timeEstimate" [color]="ui.colors.red"
                         [value]="metric.timeEstimate | percentage:(metric.plannedWorkHours * 3600)">
      </jnt-bar-indicator>
    </jnt-bar-indicator-group>
    <jnt-bar-indicator-group>
      <jnt-bar-indicator *ngIf="metric?.loading" [color]="ui.colors.purpleDark"
                         [value]="metric.loading | percentage:(metric.plannedWorkHours * 3600)">
      </jnt-bar-indicator>
    </jnt-bar-indicator-group>
  </jnt-circle-bar>
  <div class="issues" *ngIf="!!metric?.issuesCount"></div>
</ng-template>
